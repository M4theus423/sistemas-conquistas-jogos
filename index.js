const { select, input } = require('@inquirer/prompts');
const fs = require('fs').promises;
const path = require('path');

let mensagem = "üéÆ Bem-vindo ao Sistema de Conquistas!";
let jogos = [];

// ===== Persist√™ncia =====
const carregarJogos = async () => {
    try {
        const dados = await fs.readFile(path.join(__dirname, "jogos.json"), "utf-8");
        jogos = JSON.parse(dados);
    } catch {
        jogos = [];
    }
};

const salvarJogos = async () => {
    await fs.writeFile(path.join(__dirname, "jogos.json"), JSON.stringify(jogos, null, 2));
};

// ===== Fun√ß√µes auxiliares =====
const toBool = (value) => {
    return value === true || value === "true";
};

// ===== Funcionalidades =====

// 1. Cadastrar jogo
const cadastrarJogo = async () => {
    const nome = await input({ message: "Nome do jogo:" });
    if (!nome.trim()) {
        mensagem = "‚ö†Ô∏è O nome do jogo n√£o pode ser vazio.";
        return;
    }

    const plataforma = await input({ message: "Plataforma:" });
    const genero = await input({ message: "G√™nero:" });

    jogos.push({
        id: jogos.length + 1,
        nome,
        plataforma,
        genero,
        conquistas: []
    });

    mensagem = `üéÆ Jogo "${nome}" cadastrado com sucesso!`;
};

// 2. Adicionar conquista por jogo
const adicionarConquista = async () => {
    if (jogos.length === 0) {
        mensagem = "‚ö†Ô∏è Nenhum jogo cadastrado!";
        return;
    }

    const jogoId = await select({
        message: "Selecione o jogo:",
        choices: jogos.map(j => ({ name: j.nome, value: j.id }))
    });

    const jogo = jogos.find(j => j.id === jogoId);

    const titulo = await input({ message: "T√≠tulo da conquista:" });
    if (!titulo.trim()) {
        mensagem = "‚ö†Ô∏è O t√≠tulo n√£o pode ser vazio.";
        return;
    }

    const descricao = await input({ message: "Descri√ß√£o:" });
    const dificuldade = await select({
        message: "Dificuldade:",
        choices: [
            { name: "F√°cil", value: "f√°cil" },
            { name: "M√©dia", value: "m√©dia" },
            { name: "Dif√≠cil", value: "dif√≠cil" }
        ]
    });

    let pontos;
    while (true) {
        const pontosInput = await input({ message: "Pontos (n√∫mero):" });
        pontos = parseInt(pontosInput);
        if (!isNaN(pontos)) break;
        console.log("‚ö†Ô∏è Por favor, insira um n√∫mero v√°lido para os pontos.");
    }

    jogo.conquistas.push({
        id: jogo.conquistas.length + 1,
        titulo,
        descricao,
        dificuldade,
        desbloqueada: false,
        dataDesbloqueio: null,
        pontos
    });

    mensagem = `üèÜ Conquista "${titulo}" adicionada ao jogo ${jogo.nome}!`;
};

// 3. Marcar conquista como desbloqueada com data
const desbloquearConquista = async () => {
    if (!Array.isArray(jogos) || jogos.length === 0) {
        mensagem = "‚ö†Ô∏è Nenhum jogo cadastrado!";
        return;
    }

    const jogoId = await select({
        message: "Selecione o jogo:",
        choices: jogos.map(j => ({ name: j.nome || "Sem nome", value: j.id }))
    });

    const jogo = jogos.find(j => j.id === jogoId);

    if (!jogo) {
        mensagem = "‚ö†Ô∏è Jogo n√£o encontrado!";
        return;
    }

    const conquistas = Array.isArray(jogo.conquistas) ? jogo.conquistas : [];

    if (conquistas.length === 0) {
        mensagem = "‚ö†Ô∏è Este jogo n√£o possui conquistas.";
        return;
    }

    const conquistaId = await select({
        message: "Selecione a conquista para desbloquear:",
        choices: conquistas.map(c => ({ name: c.titulo || "Sem t√≠tulo", value: c.id }))
    });

    const conquista = conquistas.find(c => c.id === conquistaId);

    if (!conquista) {
        mensagem = "‚ö†Ô∏è Conquista n√£o encontrada!";
        return;
    }

    if (conquista.desbloqueada) {
        mensagem = "‚úÖ Esta conquista j√° foi desbloqueada.";
        return;
    }

    conquista.desbloqueada = true;
    conquista.dataDesbloqueio = new Date().toLocaleDateString("pt-BR");

    mensagem = `üèÖ Conquista "${conquista.titulo}" desbloqueada com sucesso!`;
};

// 4. Visualizar conquistas de um jogo
const visualizarConquistas = async () => {
    if (jogos.length === 0) {
        mensagem = "‚ö†Ô∏è Nenhum jogo cadastrado!";
        return;
    }

    const jogoId = await select({
        message: "Selecione o jogo:",
        choices: jogos.map(j => ({ name: j.nome, value: j.id }))
    });

    const jogo = jogos.find(j => j.id === jogoId);

    if (!jogo || jogo.conquistas.length === 0) {
        mensagem = "‚ö†Ô∏è Este jogo n√£o possui conquistas cadastradas.";
        return;
    }

    console.clear();
    console.log(`\nüéÆ ${jogo.nome} - ${jogo.plataforma} (${jogo.genero})`);
    console.log("‚îÅ".repeat(60));
    
    jogo.conquistas.forEach(c => {
        const status = c.desbloqueada ? "‚úÖ" : "üîí";
        const data = c.desbloqueada ? ` [${c.dataDesbloqueio}]` : "";
        console.log(`\n${status} ${c.titulo} - ${c.pontos} pts`);
        console.log(`   ${c.descricao}`);
        console.log(`   Dificuldade: ${c.dificuldade}${data}`);
    });
    
    console.log("\n" + "‚îÅ".repeat(60));
    await input({ message: "\nPressione ENTER para continuar..." });
};

// 5. Estat√≠sticas por jogo
const estatisticas = async () => {
    if (jogos.length === 0) {
        mensagem = "‚ö†Ô∏è Nenhum jogo cadastrado!";
        return;
    }

    const jogoId = await select({
        message: "Selecione o jogo:",
        choices: jogos.map(j => ({ name: j.nome, value: j.id }))
    });

    const jogo = jogos.find(j => j.id === jogoId);

    if (!jogo) {
        mensagem = "‚ö†Ô∏è Jogo n√£o encontrado!";
        return;
    }

    const total = jogo.conquistas.length;
    const desbloqueadas = jogo.conquistas.filter(c => c.desbloqueada).length;
    const percentual = total > 0 ? ((desbloqueadas / total) * 100).toFixed(1) : 0;
    
    const pontosGanhos = jogo.conquistas
        .filter(c => c.desbloqueada)
        .reduce((sum, c) => sum + c.pontos, 0);
    
    const pontosTotal = jogo.conquistas.reduce((sum, c) => sum + c.pontos, 0);

    const porDificuldade = {
        f√°cil: { total: 0, desbloqueadas: 0 },
        m√©dia: { total: 0, desbloqueadas: 0 },
        dif√≠cil: { total: 0, desbloqueadas: 0 }
    };

    jogo.conquistas.forEach(c => {
        porDificuldade[c.dificuldade].total++;
        if (c.desbloqueada) {
            porDificuldade[c.dificuldade].desbloqueadas++;
        }
    });

    console.clear();
    console.log(`\nüìä Estat√≠sticas - ${jogo.nome}`);
    console.log("‚îÅ".repeat(60));
    console.log(`\nüéÆ Progresso Geral:`);
    console.log(`   Total de conquistas: ${total}`);
    console.log(`   Desbloqueadas: ${desbloqueadas} (${percentual}%)`);
    console.log(`   Pontos: ${pontosGanhos}/${pontosTotal}`);
    
    console.log(`\nüìà Por Dificuldade:`);
    console.log(`   F√°cil: ${porDificuldade.f√°cil.desbloqueadas}/${porDificuldade.f√°cil.total}`);
    console.log(`   M√©dia: ${porDificuldade.m√©dia.desbloqueadas}/${porDificuldade.m√©dia.total}`);
    console.log(`   Dif√≠cil: ${porDificuldade.dif√≠cil.desbloqueadas}/${porDificuldade.dif√≠cil.total}`);
    
    console.log("\n" + "‚îÅ".repeat(60));
    await input({ message: "\nPressione ENTER para continuar..." });
};

// 6. Ranking de jogos
const ranking = async () => {
    if (jogos.length === 0) {
        mensagem = "‚ö†Ô∏è Nenhum jogo cadastrado!";
        return;
    }

    const ranking = jogos.map(jogo => {
        const total = jogo.conquistas.length;
        const desbloqueadas = jogo.conquistas.filter(c => c.desbloqueada).length;
        const percentual = total > 0 ? ((desbloqueadas / total) * 100).toFixed(1) : 0;
        const pontosGanhos = jogo.conquistas
            .filter(c => c.desbloqueada)
            .reduce((sum, c) => sum + c.pontos, 0);

        return {
            nome: jogo.nome,
            total,
            desbloqueadas,
            percentual: parseFloat(percentual),
            pontosGanhos
        };
    }).sort((a, b) => b.percentual - a.percentual || b.pontosGanhos - a.pontosGanhos);

    console.clear();
    console.log("\nüèÜ Ranking de Jogos");
    console.log("‚îÅ".repeat(60));
    
    ranking.forEach((jogo, index) => {
        const posicao = index + 1;
        const medalha = posicao === 1 ? "ü•á" : posicao === 2 ? "ü•à" : posicao === 3 ? "ü•â" : `${posicao}¬∫`;
        console.log(`\n${medalha} ${jogo.nome}`);
        console.log(`   Progresso: ${jogo.desbloqueadas}/${jogo.total} (${jogo.percentual}%)`);
        console.log(`   Pontos: ${jogo.pontosGanhos}`);
    });
    
    console.log("\n" + "‚îÅ".repeat(60));
    await input({ message: "\nPressione ENTER para continuar..." });
};

// ===== Sistema =====
const mostrarMensagem = () => {
    console.clear();
    if (mensagem) {
        console.log(mensagem + "\n");
        mensagem = "";
    }
};

const start = async () => {
    await carregarJogos();

    while (true) {
        mostrarMensagem();
        await salvarJogos();

        const opcao = await select({
            message: "üéÆ Menu >",
            choices: [
                { name: "Cadastrar jogo", value: "cadastrarJogo" },
                { name: "Adicionar conquista", value: "adicionarConquista" },
                { name: "Desbloquear conquista", value: "desbloquearConquista" },
                { name: "Visualizar conquistas", value: "visualizar" },
                { name: "Estat√≠sticas por jogo", value: "estatisticas" },
                { name: "Ranking de jogos", value: "ranking" },
                { name: "Sair", value: "sair" }
            ]
        });

        switch (opcao) {
            case "cadastrarJogo": await cadastrarJogo(); break;
            case "adicionarConquista": await adicionarConquista(); break;
            case "desbloquearConquista": await desbloquearConquista(); break;
            case "visualizar": await visualizarConquistas(); break;
            case "estatisticas": await estatisticas(); break;
            case "ranking": await ranking(); break;
            case "sair": console.log("üëã At√© a pr√≥xima!"); return;
        }
    }
};

start();
